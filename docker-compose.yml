version: '3.8'

services:
  # CodeBERT Embedding Service
  codebert:
    build:
      context: ./services/codebert
      dockerfile: Dockerfile
    container_name: codementor-codebert
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - MODEL_NAME=microsoft/codebert-base
    volumes:
      - codebert-cache:/root/.cache/huggingface
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s  # Model is already downloaded during build
    deploy:
      resources:
        limits:
          memory: 4G

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: codementor-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CodeMentor API Server
  codementor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: codementor-api
    ports:
      - "8080:8080"
    environment:
      - CODEMENTOR_OLLAMA_HOST=http://host.docker.internal:11434
      - CODEMENTOR_OLLAMA_CHAT_MODEL=qwen2.5:0.5b
      - CODEMENTOR_EMBEDDING_PROVIDER=codebert
      - CODEMENTOR_EMBEDDING_HOST=http://codebert:8001
      - CODEMENTOR_VECTOR_TYPE=qdrant
      - CODEMENTOR_VECTOR_HOST=qdrant
      - CODEMENTOR_VECTOR_PORT=6333
    volumes:
      - codementor-data:/app/data
      - codementor-cache:/app/.codementor
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      codebert:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  codebert-cache:
    driver: local
  qdrant-data:
    driver: local
  codementor-data:
    driver: local
  codementor-cache:
    driver: local

# Usage:
# 1. Make sure Ollama is running on host: ollama serve
# 2. Start all services: docker-compose up -d
# 3. CodeBERT model is downloaded during build, startup is fast
# 4. Check health: curl http://localhost:8080/health
# 5. Check CodeBERT: curl http://localhost:8001/health
# 6. Create session: curl -X POST http://localhost:8080/api/v1/sessions -H "Content-Type: application/json" -d '{"repo_path": "/path/to/repo"}'
